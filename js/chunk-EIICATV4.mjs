import{a as x,b as B,e as w}from"chunk-K2O2DWCZ.mjs";import{a as L}from"chunk-WPFEDOJI.mjs";import{Qc as P}from"chunk-NYFEUS7P.mjs";import{g as v}from"chunk-75ILXMIH.mjs";import{Wp as D,fk as z,hc as l,pb as S,wk as N,zk as b}from"chunk-LIUGL3AW.mjs";import{b as I,j as s,m as p,p as V,s as h}from"chunk-CMAEAGWD.mjs";import{j as g}from"chunk-EEV263O3.mjs";import{a as u}from"chunk-YOOGIIWU.mjs";import{j as m}from"chunk-AHQIRSXG.mjs";var M=class{constructor(t){this.environment=t;m(this,"dataByRenderId",new Map);m(this,"itemIdsByRenderId",new Map);m(this,"updatedDataByNodeId",new Map);m(this,"updatedItemIdsByRenderId",new Map)}set(t,a,n){if(u(this.environment==="sandbox","Setting data is only allowed in the sandbox."),a??=g(),this.dataByRenderId.get(t)===a)return;if(this.dataByRenderId.set(t,a),L(t)){let d=O(a,n);this.updatedDataByNodeId.set(t,d)}let r=a.map(w),o=this.itemIdsByRenderId.get(t);S(r,o)||(this.itemIdsByRenderId.set(t,r),this.updatedItemIdsByRenderId.set(t,r))}import(t){u(this.environment==="editor","Importing data is only allowed in the editor.");let{dataUpdates:a,itemIdsUpdates:n}=t,e=new Set;for(let{nodeId:r,data:o}of a)this.dataByRenderId.set(r,o),e.add(r);for(let{renderId:r,itemIds:o}of n)this.itemIdsByRenderId.set(r,o),e.add(r);return e}isEmpty(t){let a=this.dataByRenderId.get(t);return!a||a.length===0}getData(t){return this.dataByRenderId.get(t)}getItemIds(t){return this.itemIdsByRenderId.get(t)}export(){if(u(this.environment==="sandbox","No need to collect and send updates from within the editor."),this.updatedDataByNodeId.size===0&&this.updatedItemIdsByRenderId.size===0)return;let t=[];for(let[n,e]of this.updatedDataByNodeId)t.push({nodeId:n,data:e});this.updatedDataByNodeId.clear();let a=[];for(let[n,e]of this.updatedItemIdsByRenderId)a.push({renderId:n,itemIds:e});return this.updatedItemIdsByRenderId.clear(),{dataUpdates:t,itemIdsUpdates:a}}};function O(i,t){return i.map(a=>{let n={};for(let e in a){let r=t.get(e);if(r)switch(r.type){case"vectorsetitem":n[e]=void 0;continue;case"richtext":n[e]=a[e]?"<p>Content</p>":null;continue;case"object":throw Error("Not currently handled in removeNonSerializableData");case"slot":throw Error("Should never be part of repeater data");default:n[e]=a[e]}}return n})}function Z(i){let t=new Map;for(let a of i)a.type!=="divider"&&t.set(a.id,a);return t}function T(i,t,a,n,e,r){if(t.type!=="string"||I(a?.value))return;let o=n.get(i);if(o?.type!=="string"||o.fallbackValue!=="associatedVariable")return;let d=o.associatedStringVariable;if(V(d))return;let c=r.getControlProp(d),y=e[d];if(s(y))return;let R=D(y,c);if(R?.type==="string")return R}function _(i,t,a,n,e){let r=e.getControlProp(i),d=T(i,t,r,a,n,e)??D(t,r);if(B(d))return d}function U({control:i,controlProp:t,resolvers:a,locale:n}){switch(t.type){case"array":{u(i.type==="array","Invalid control");let{value:e}=t;if(l(e))return;let r=e.map(o=>U({control:i.control,controlProp:o,resolvers:a,locale:n})??null);return{type:"array",value:r}}case"boolean":{let{value:e}=t;return l(e)||p(e)?void 0:{type:"boolean",value:e}}case"collectionreference":{let{value:e}=t;return l(e)||s(e)?void 0:{type:"string",value:e}}case"color":{let{value:e}=t;if(l(e)||p(e))return;let r=a.resolveColor(e);return s(r)?void 0:{type:"color",value:r}}case"date":{u(i.type==="date","Invalid control");let{value:e}=t;if(l(e)||s(e))return;let r=new Date(e);return h(r)?(i.displayTime||r.setUTCHours(0,0,0,0),{type:"date",value:r.toISOString()}):void 0}case"enum":{let{value:e}=t;return l(e)||s(e)?void 0:(u(I(e),"Enum is not a string"),{type:"enum",value:e})}case"file":{let{value:e}=t;if(l(e)||s(e))return;let r=a.resolveFile(e);return s(r)?void 0:{type:"file",value:r}}case"image":{let e=f(i,t.valueLocalized,n),r=e?.value??t.value;if(l(r)||s(r))return;let o=e?.imageFocalPoint??t,d=a.resolveImage(r,o);if(s(d))return;let y=f(i,t.altLocalized,n)?.value??t.alt;return{type:"responsiveimage",value:{...d,alt:y}}}case"link":{let e=b(t.value);if(N(e)){let o=f(i,t.valueLocalized,n);o?.value&&(e=b(o.value))}if(l(e)||s(e))return;let r=a.resolveLink(e);return s(r)?void 0:{type:"link",value:r}}case"multicollectionreference":{let{value:e}=t;return l(e)||s(e)?void 0:{type:"array",value:e.map(r=>({type:"string",value:r}))}}case"number":{let{value:e}=t;return l(e)||p(e)?void 0:{type:"number",value:e}}case"object":{u(i.type==="object","Invalid control");let{value:e}=t;if(l(e)||p(e))return;let r=P(i.controls,(o,d)=>{let c=e[o];return c?U({control:d,controlProp:c,resolvers:a,locale:n})??null:null});return z(t)&&(r[v]={type:"string",value:t.id}),{type:"object",value:r}}case"richtext":{let r=f(i,t.valueLocalized,n)?.value??t.value;if(l(r)||x(r))return;let o=a.resolveRichTextPointer(r);return s(o)?void 0:{type:"richtext",value:o}}case"string":{let r=f(i,t.valueLocalized,n)?.value??t.value;return l(r)||p(r)?void 0:{type:"string",value:r}}case"vectorsetitem":{let{value:e}=t;if(l(e)||s(e))return;let r=a.resolveVectorSetItemPointer(e);return s(r)?void 0:{type:"vectorsetitem",value:r}}default:}}function f(i,t,a){if(!(!t||!a||E(i)))for(;a;){let e=t[a.id];if(e&&!p(e.value))return e;a=a.fallback}}function E(i){return"preventLocalization"in i?i.preventLocalization??!1:!1}function k(i,t=a=>a){switch(i.type){case"array":{let a=k(i.control,t);return a.definitions[v]={type:t("string"),isNullable:!1},{type:t("array"),isNullable:!0,definition:a}}case"boolean":case"color":case"date":case"enum":case"file":case"link":case"number":case"richtext":case"string":return{type:t(i.type),isNullable:!0};case"collectionreference":return{type:t("string"),isNullable:!0};case"image":case"responsiveimage":return{type:t("responsiveimage"),isNullable:!0};case"multicollectionreference":return{type:t("array"),isNullable:!0,definition:{type:t("string"),isNullable:!0}};case"object":{let a=Object.entries(i.controls),n={};for(let[e,r]of a){let o=k(r,t);o&&(n[e]=o)}return{type:t("object"),isNullable:!0,definitions:n}}case"vectorsetitem":return{type:t("vectorsetitem"),isNullable:!0};default:}}export{M as a,Z as b,_ as c,U as d,k as e};
//# sourceMappingURL=chunk-EIICATV4.mjs.map
