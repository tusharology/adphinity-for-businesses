import{d as F}from"chunk-JSNDXE3K.mjs";import{Ka as de,nh as I,ni as N}from"chunk-NYFEUS7P.mjs";import{a as re,b as se,d as ae,e as M}from"chunk-75ILXMIH.mjs";import{In as ce,Lf as le,pc as ie}from"chunk-G5CI4O4F.mjs";import{Gk as E,Ik as oe,Im as ne,Jd as Q,Pd as X,Qd as Y,Sc as G,Tc as L,Uc as H,Wd as Z,Xc as w,Zc as R,ek as $,ge as _,je as ee,me as te,od as J,rd as q,vd as A}from"chunk-LIUGL3AW.mjs";import{b as g,e as j,f as y,g as T}from"chunk-CMAEAGWD.mjs";import{Z as z,da as B}from"chunk-EEV263O3.mjs";import{a as v}from"chunk-YOOGIIWU.mjs";import{j as C}from"chunk-AHQIRSXG.mjs";var O=class extends Error{constructor(e,o){super(`Document version is too low. Expected ${o}, got ${e}.`)}},V=class extends Error{constructor(e,o){super(`Document version is too high. Expected ${o}, got ${e}.`)}};function me(t){if(!se(t)||t===null)throw Error("Invalid document.");if(!j(t.version))throw Error("Unable to read document.version");if(!t.root)throw Error("Unable to read document.root");if(t.version<N.minimumLegacySerializationVersion)throw new O(t.version,N.minimumLegacySerializationVersion);if(t.version>M)throw new V(t.version,M)}function k(t,e){let o=!1;function n(l,d,s){if(!l)return;let a=l.id;if(s.has(a)){o=!0,e&&e.push({id:a,stack:d.slice()});return}if(s.add(a),d.push(a),A(l)){let c=l.getRawControlProps(),p=Object.keys(c);for(let u of p){let f=c[u];if(f){if(f.type==="slot"&&T(f.value))for(let h of f.value){if(!y(h))continue;let x=h["reference"];if(!g(x))continue;let Te=t.get(x);n(Te,d,s)}else if(f.type==="componentinstance"&&g(f.value)){let h=t.get(f.value);n(h,d,s)}else if(T(f.value))for(let h of f.value){if(!y(h)||h.type!=="componentinstance")continue;let b=h.value;if(!g(b))continue;let x=t.get(b);n(x,d,s)}}}}let m=l.children;if(m)for(let c=0,p=m.length;c<p;c++)n(m[c],d,s);s.delete(a),d.pop()}let i=new Set,r=[];return n(t.root,r,i),o}function Xe(t,e,o){me(t);let n=ae(t),i=I(n.root,null,{extraChecksAndFixes:!0,errors:o,warnings:o});if(!i)throw Error("Unable to create load document");pe(i,o);let r=new Map;D(r,o,i,E),fe(r,i,o);let l=N.createByAdoptingRoot(i);l.verify(),l=ie.treeDidLoad(l,e,o).didNonLinearMove(e);let d=[];return k(l,d)&&(d.forEach(s=>{o.push(`${s.id}: code component links itself via ${s.stack}`),W(l,s.id,s.stack)}),l=l.commit(e)),l}function Ye(t,e){pe(t,e);let o=new Map;D(o,e,t,E),fe(o,t,e)}function K(t,e){let o=new Map;D(o,e,t,t.parentid),Ae(o,t,e)}function be(t){return q(t)||J(t)}function pe(t,e=[]){let o=t.children,n=o.find(be);n===void 0&&(e.push(`${t.id}: Root does not contain a page`),n=new de({id:re(t)}),o.push(n));for(let i=0;i<o.length;i++){let r=o[i];r&&(le(r)||H(r)||te(r)||ce(r)||Z(r)||Q(r)||X(r)||_(r)||ee(r)||Y(r)||(e.push(`${r.id}: Ground node is not on a page`),o.splice(i--,1),n.children.push(r),r.parentid=n.id))}}function W(t,e,o){let n=t.get(o[o.length-1]);if(!A(n))return;let i=n.getRawControlProps(),r={};for(let d in i){let s=i[d];if(!s)continue;let{type:a,value:m}=s;if(a==="slot"&&T(m)){let c=m.filter(p=>y(p)?p["reference"]!==e:!0);c.length!==m.length&&(r[d]={type:"slot",value:c})}else if(a==="componentinstance"&&m===e)r[d]={type:"slot",value:[]};else if(T(m)){let c=m.filter(p=>!y(p)||p.type!=="componentinstance"?!0:p.value!==e);c.length!==m.length&&(r[d]={type:"array",value:c})}}if(z(r))return;let l=ne(r);n.set(l)}function D(t,e,o,n){for(o.parentid=n;t.has(o.id);)e.push(`${o.id}: duplicate id in document`),o.id=oe();t.set(o.id,o);let i=o.children;if(i)for(let r=0,l=i.length;r<l;r++)D(t,e,i[r],o.id)}function fe(t,e,o){for(let n of e.walk())v(n.isMutable()),A(n)&&ue(t,n.id,new Set([n.id]),n,o),L(n)&&he(t,n,n,o),w(n)&&(ge(t,n,o),Ce(t,n,o)),R(n)&&ve(n,o)}function Ae(t,e,o){for(let n of e.walk())v(n.isMutable()),w(n)?Ce(t,n,o):R(n)&&ve(n,o)}function ue(t,e,o,n,i){function r(s){if(!g(s))return!1;if(o.has(s))return i.push(`${e}: code component links itself via ${n.id}`),!0;let a=t.get(s);if(!a)return i.push(`${n.id}: code component has bad link at ${s}`),!0;let m=!1;for(let c of a.walk())o.has(c.id)?(i.push(`${e}: code component links itself via ${n.id} via ${s}`),m=!0):A(c)&&ue(t,e,new Set([...o,c.id]),c,i);return m}let l=n.getRawControlProps(),d=Object.keys(l);for(let s of d){let a=l[s];if(!$(a))continue;if(a.type==="slot"&&T(a.value)){let p=[];for(let u=0;u<a.value.length;u++){let f=a.value[u];if(!y(f))continue;let b=f["reference"];g(b)&&r(b)&&p.push(u)}for(;p.length>0;)a.value.splice(p.pop(),1);continue}if(a.type==="componentinstance"&&g(a.value)){if(!r(a.value))continue;a.value=void 0;continue}let m=a.value;if(!Array.isArray(m))continue;let c=[];for(let p=0,u=m.length;p<u;p++){let f=m[p];$(f)&&f.type==="componentinstance"&&g(f.value)&&r(f.value)&&c.push(p)}for(;c.length>0;)m.splice(c.pop(),1)}}function U(t){t.originalid=null,t.replicaInfo=null}function he(t,e,o,n){for(let i of o.walk())if(i!==o&&G(i)&&w(i)){let r=ge(t,i,n);if(!r)continue;if(e===r){n.push(`${e.id}: template component links itself via ${o.id}`),U(i);continue}he(t,e,r,n)}}function ge(t,e,o){let n=e.replicaInfo.master,i=t.get(n);return i?L(i)?(e.originalid!==n&&(o.push(`${e.id}: template originalid doesn't point to master id: ${e.originalid}`),e.originalid=n),i):(o.push(`${e.id}: template references a node that is not a master: ${n}`),U(e),null):(o.push(`${e.id}: template references a master that doesn't exist: ${n}`),U(e),null)}function Ce(t,e,o){if(!e.replicaInfo)return;let n=e.replicaInfo.inheritsFrom;if(!n)return;let i=t.get(n);i?!L(i)&&!w(i)&&(o.push(`${e.id}: template references an inherit that isn't a master or a replica: ${n}`),e.replicaInfo.inheritsFrom=void 0):(o.push(`${e.id}: template references an inherit that doesn't exist: ${n}`),e.replicaInfo.inheritsFrom=void 0)}function ve(t,e){t.originalid&&(t.originalid=null,e.push(`${t.id}: removing original id from orphan replica child`))}var S=B("remote:verify");function rt(t,e,o,n){let i=t.getPartialDocumentForPageIds(o),r=[],l=S.isLoggingTraceMessages()?[]:void 0,d=I(i,null,{extraChecksAndFixes:!0,errors:r,warnings:l});F("parsingRootNode"),v(d,"error loading root node:",i.id,r);for(let a of d.children??[])a.children&&a.children.length>0&&K(a,r);r.length>0&&S.warn("errors loading server tree: "+r.join(`
`)),l&&l.length>0&&S.trace("warnings loading server tree: "+l.join(`
`));let s=N.createByAdoptingRoot(d,n);return s.loadReplicasAndCodeComponents(s.root),F("parsingReplicasExpansion"),s.hasUncommittedChanges()&&(s=s.commit(e)),s}function st(t,e){let o=t.parseNextPage();if(!o)return!0;let n=[],i=I(o,t.root.id,{extraChecksAndFixes:!0,errors:n});return v(i,"error loading page node:",o.id,n),K(i,n),n.length>0&&S.warn("warnings loading server tree: "+n.join(`
`)),e.set(i.id,i),!1}function at(t,e,o){t.makeLatest(),t.editClosed=!1,t.isViewOnly=!1;for(let[n,i]of t.root.children.entries()){let r=o.get(i.id);r&&(t.remove(r.id),t.insertNode(r,t.root.id,n))}return t.inEditor=!1,t.loadReplicasAndCodeComponents(t.root),t.hasUncommittedChanges()&&(t=t.commit(e)),t.inEditor=!0,t}var P=class t{constructor(){C(this,"editClosed",!1);C(this,"isViewOnly",!1);C(this,"inEditor",!1);C(this,"processingLocalUserEdits",!1)}static from(e){let o=new t;return o.editClosed=e.editClosed,o.isViewOnly=e.isViewOnly,o.inEditor=e.inEditor,o.processingLocalUserEdits=e.processingLocalUserEdits,o}restore(e){e.editClosed=this.editClosed,e.isViewOnly=this.isViewOnly,e.inEditor=this.inEditor,e.processingLocalUserEdits=this.processingLocalUserEdits}static setForAssembly(e){e.editClosed=!1,e.isViewOnly=!1,e.inEditor=!1,e.processingLocalUserEdits=!1}},ye=class{constructor(e,o,n){this.engine=e;this.treeToAssemble=o;C(this,"pagesToAssemble");C(this,"isSetupNeeded",!0);C(this,"engineTreeFlags",new P);this.pagesToAssemble=Array.from(n.values())}setupAssemblerTreeStateIfNeeded(){this.isSetupNeeded&&(this.isSetupNeeded=!1,this.engineTreeFlags=P.from(this.engine.tree),this.treeToAssemble.isLatest()||this.treeToAssemble.makeLatest(),P.setForAssembly(this.treeToAssemble))}restoreEngineTreeState(){this.isSetupNeeded||(this.isSetupNeeded=!0,this.treeToAssemble.hasUncommittedChanges()&&(this.treeToAssemble=this.treeToAssemble.commit(this.engine.componentLoader)),this.engine.tree.isLatest()||this.engine.tree.makeLatest(),this.engineTreeFlags.restore(this.engine.tree))}assembleOnePage(){if(this.pagesToAssemble.length===0)return!0;this.setupAssemblerTreeStateIfNeeded();let e=this.pagesToAssemble.pop();v(e);let o=this.treeToAssemble.root.children.findIndex(n=>n.id===e.id);return o<0?!1:(this.treeToAssemble.remove(e.id),this.treeToAssemble.insertNode(e,this.treeToAssemble.root.id,o),this.treeToAssemble.loadReplicasAndCodeComponents(e),this.treeToAssemble=this.treeToAssemble.commit(this.engine.componentLoader),this.pagesToAssemble.length===0)}buildCompleteTree(){v(this.pagesToAssemble.length===0,"must be done with assembleOnePage"),this.setupAssemblerTreeStateIfNeeded(),this.treeToAssemble.loadReplicasAndCodeComponents(this.treeToAssemble.root),this.treeToAssemble.hasUncommittedChanges()&&(this.treeToAssemble=this.treeToAssemble.commit(this.engine.componentLoader)),this.treeToAssemble.verify();let e=[],o=[];return k(this.treeToAssemble,o)&&(o.forEach(n=>{e.push(`${n.id}: code component links itself via ${n.stack}`),W(this.treeToAssemble,n.id,n.stack)}),this.treeToAssemble=this.treeToAssemble.commit(this.engine.componentLoader)),e.length>0&&S.warn("warnings loading server tree: "+e.join(`
`)),this.engineTreeFlags.restore(this.treeToAssemble),this.treeToAssemble}};export{k as a,Xe as b,Ye as c,K as d,W as e,rt as f,st as g,at as h,P as i,ye as j};
//# sourceMappingURL=chunk-2WLJEEWM.mjs.map
