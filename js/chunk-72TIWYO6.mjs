import{A as he,j as Fe}from"chunk-YJLTZXOK.mjs";import{a as te}from"chunk-SPWSWTND.mjs";import{a as ze}from"chunk-ZOR27MRK.mjs";import{a as ce,e as le}from"chunk-WPFEDOJI.mjs";import{Ch as qe,Ih as De,Q as Oe,nh as J,ni as ee}from"chunk-NYFEUS7P.mjs";import{Gh as Ee,b as ae,sn as A,zl as Le}from"chunk-G5CI4O4F.mjs";import{E as N,Ja as Ce,L as R,Lk as ue,Sf as Ne,cb as ve,cc as Me,hc as Se,hd as oe,lp as Pe,ud as be,vd as we}from"chunk-LIUGL3AW.mjs";import{fa as ke,g as Re}from"chunk-RT6MD2HE.mjs";import{b as xe,j as _,p as Te}from"chunk-CMAEAGWD.mjs";import{eg as de}from"chunk-NNG7ZAML.mjs";import{da as Q,r as G,s as Z,t as K,w as F}from"chunk-EEV263O3.mjs";import{a as w}from"chunk-YOOGIIWU.mjs";import{j as l,k as se,l as Ie}from"chunk-AHQIRSXG.mjs";var k=Q("PartialTreeReceiver"),Ae=class{constructor(e){this.componentLoader=e;l(this,"name","uninitialized");l(this,"tree");l(this,"chunkBuffer",new Map);l(this,"currentChunkId");l(this,"expectedTotalChunks",0);l(this,"chunkTimeout");l(this,"chunkTimeoutMs",3e4);l(this,"chunkStartTime");this.tree=ee.createWithRouteSegmentRoot()}clearChunkState(){this.chunkTimeout&&(clearTimeout(this.chunkTimeout),this.chunkTimeout=void 0),this.chunkBuffer.clear(),this.currentChunkId=void 0,this.expectedTotalChunks=0,this.chunkStartTime=void 0}update(e){if(De(Oe),e.name&&(this.name=e.name),e.treeChunks)return this.handleChunkedUpdate(e.treeChunks);if(e.tree){k.debug(this.name,"received new tree",`took ${Date.now()-(e.timestamp||0)}ms to receive update`);let t=J(e.tree.root);w(t,"error creating root from update message");let n=ee.createByAdoptingRoot(t);n.loadReplicasAndCodeComponents(n.root),this.tree=n}if(e.changes&&(k.trace(this.name,"applying changes"),qe(this.tree,e.changes)),e.scopes){let t=this.tree.root.id;k.trace(this.name,"updating scopes:",e.scopes.length,`took ${Date.now()-(e.timestamp||0)}ms to receive update`);for(let n of e.scopes){let r=J(n,t);w(r,"error creating scope from update message"),this.tree.remove(r.id),this.tree.insertNode(r,t),this.tree.loadReplicasAndCodeComponents(r)}}return this.tree.hasUncommittedChanges()&&(k.trace(this.name,"commit"),this.tree=this.tree.commitDiffs(this.componentLoader)),this.tree}handleChunkedUpdate(e){try{if(w(e.chunkIndex>=0&&e.chunkIndex<e.totalChunks,`Invalid chunk index: ${e.chunkIndex} not in range [0, ${e.totalChunks})`),(!this.currentChunkId||this.currentChunkId!==e.chunkId)&&(this.clearChunkState(),this.currentChunkId=e.chunkId,this.expectedTotalChunks=e.totalChunks,this.chunkStartTime=performance.now(),k.debug(this.name,`starting new chunked transfer: ${e.totalChunks} chunks expected`),this.chunkTimeout=setTimeout(()=>{k.warn(this.name,`chunk timeout: clearing incomplete transfer for ${e.chunkId}`),this.clearChunkState()},this.chunkTimeoutMs)),w(e.totalChunks===this.expectedTotalChunks,`Chunk count mismatch: expected ${this.expectedTotalChunks}, got ${e.totalChunks}`),this.chunkBuffer.has(e.chunkIndex))return k.warn(this.name,`duplicate chunk received: ${e.chunkIndex}`),null;this.chunkBuffer.set(e.chunkIndex,{chunkId:e.chunkId,chunkIndex:e.chunkIndex,totalChunks:e.totalChunks,nodes:e.nodes,childrenMap:e.childrenMap,rootId:e.rootId})}catch(t){return k.error(this.name,"chunk processing error:",t),this.clearChunkState(),null}if(k.debug(this.name,`received chunk ${e.chunkIndex+1}/${e.totalChunks}`),this.chunkBuffer.size===e.totalChunks){k.debug(this.name,"all chunks received, assembling tree");let t=this.assembleTreeFromChunks();return this.clearChunkState(),this.tree=t,t}return null}assembleTreeFromChunks(){let e=new Map,t=new Map,n;for(let c=0;c<this.expectedTotalChunks;c++){let h=this.chunkBuffer.get(c);if(!h)throw new Error(`Missing chunk ${c} in chunked tree transfer`);if(!h.nodes||h.nodes.size===0)throw new Error(`Chunk ${c} has no nodes`);if(h.nodes.forEach((m,f)=>{if(!m||!f)throw new Error(`Invalid node data in chunk ${c}`);e.set(f,m)}),h.childrenMap)for(let[m,f]of h.childrenMap)t.set(m,f);h.rootId&&(n=h.rootId)}if(!n)throw new Error("No root ID found in chunked tree transfer");if(e.size===0)throw new Error("No nodes found in chunked tree transfer");function r(c){let h=e.get(c);if(!h)throw new Error(`Node ${c} not found in chunks`);let m=t.get(c);return m&&m.length>0&&(h.children=m.map(r)),h}let o=r(n),i=J(o);w(i,"error creating root from chunked tree");let a=ee.createByAdoptingRoot(i);a.loadReplicasAndCodeComponents(a.root);let u=this.chunkStartTime?performance.now()-this.chunkStartTime:0,d=u>1e3?`${(u/1e3).toFixed(2)}s`:`${Math.round(u)}ms`;return k.debug(this.name,`successfully assembled tree from ${this.expectedTotalChunks} chunks with ${e.size} nodes in ${d}`),a}};var Ye="getFontsForLoading";function It(s){return Ye in s}var me=Ce.getTaskQueue("optimizedImages",{priority:0,maxBatchSize:1,useAnimationFrame:!0});var fe=[128,512],Ue=4,Ve=class{constructor(e){this.trackThumbnailLoad=e;l(this,"canRenderCanvasImage",e=>e.includes("framerusercontent.com/"));l(this,"zoom",1);l(this,"imageStates",new Map);l(this,"resizeObserver",new ResizeObserver(e=>{for(let t of e){let n=t.target,r=this.getCurrentImageState(n);if(!r||!r.inViewport)continue;let o=Math.round(t.contentRect.width/this.zoom),i=Math.round(t.contentRect.height/this.zoom);o===0||i===0||r&&r.width===o&&r.height===i||(r.width=o,r.height=i,this.computeNextImage(n,r))}}));l(this,"intersectionObserver",new IntersectionObserver(e=>{for(let t of e){let n=t.target,r=this.getCurrentImageState(n);if(!r||t.boundingClientRect.width===0||t.boundingClientRect.height===0)continue;let o=0,i=0,a=t.isIntersecting||je(t);a?(o=Math.round(t.boundingClientRect.width/this.zoom),i=Math.round(t.boundingClientRect.height/this.zoom)):(o=r.width,i=r.height),!(r&&r.width===o&&r.height===i&&r.inViewport===a)&&(r.width=o,r.height=i,r.inViewport=a,this.computeNextImage(n,r))}},{rootMargin:"50px",threshold:.05}));l(this,"renderCanvasImage",(e,t,n,r)=>{let o=e.parentElement;if(!o)return;let i=this.getOrCreateImageState(o,e,n),a=!1;a=this.updateImageSource(o,i,0,t,r),a=this.updateImageSource(o,i,1,t)||a,a=this.updateImageSource(o,i,2,t)||a,a&&(i.show=-1,this.computeNextImage(o,i),this.resizeObserver.observe(o),this.intersectionObserver.observe(o))});l(this,"scheduled",!1);l(this,"scheduledRenderings",new Set);l(this,"processRenderMainImage",()=>{this.scheduled=!1;let e=0;for(let t of this.scheduledRenderings){this.scheduledRenderings.delete(t);let n=this.imageStates.get(t);if(n&&(this.renderImage(n),n.show!==0&&(e++,e>Ue)))break}this.scheduledRenderings.size>0&&(this.scheduled=!0,me.add(this.processRenderMainImage))})}getImageSrc(e,t){if(t===-1||t===2)return e;let n=fe[t],r=e.match(/(.*?)\/assets\/(\d+)\/([^.]+\.[a-zA-Z\d]+)/);if(r)return`${r[1]}/assets/${n}/${r[3]}`;let o=e.match(/(.*?)\/assets\/([^.]+\.[a-zA-Z\d]+)/);if(o)return`${o[1]}/assets/${n}/${o[2]}`;let i=new URL(e);return i.searchParams.set("scale-down-to",String(n)),i.toString()}setZoom(e){if(this.zoom!==e){this.zoom=e;for(let[t,n]of this.imageStates)this.computeNextImage(t,n)}}getCurrentImageState(e){if(!e.isConnected){this.imageStates.delete(e),this.resizeObserver.unobserve(e),this.intersectionObserver.unobserve(e);return}return this.imageStates.get(e)}getOrCreateImageState(e,t,n){let r=this.imageStates.get(e);return r?(ge(r.images[0]?.img,n,t),ge(r.images[1]?.img,n,t),ge(r.images[2]?.img,n,t),r):(r={width:0,height:0,inViewport:!0,error:!1,show:-1,images:[{img:pe(t,n,0),src:"",loaded:!1},{img:pe(t,n),src:"",loaded:!1},{img:pe(t,n),src:"",loaded:!1}]},this.imageStates.set(e,r),r)}hasSmallerImageLoaded(e,t){return e.images[t-1]?.loaded??!0}loadLargerImage(e,t){for(let n=t+1;n<=2;n++){let r=e.images[n];if(r&&!r.loaded&&r.img.src!==r.src){r.img.src=r.src;return}}}updateImageSource(e,t,n,r,o){let i=t.images[n];if(!i)return!1;let a=this.getImageSrc(r,n);if(i.src===a)return!1;let u=n===0&&i.src==="";i.src=a,i.loaded=!1,i.img.style.visibility!=="hidden"&&!u&&(i.img.style.visibility="hidden");let d=!1,c;return n===0&&o&&this.trackThumbnailLoad&&this.trackThumbnailLoad(o,()=>new Promise(h=>{c=h,d?h():setTimeout(h,2e3)})),i.img.onload=()=>{d=!0,c?.(),i.src===a&&(this.loadLargerImage(t,n),i.loaded=i.img.naturalWidth>0,n===2&&(t.error=!i.loaded),this.computeNextImage(e,t))},this.hasSmallerImageLoaded(t,n)&&(i.img.src=a),!0}updateImageVisibility(e,t){let n=e.images[t]?.img.style;if(!n)return;let r=e.show===t?"visible":"hidden";n.visibility!==r&&(n.visibility=r)}computeShow(e){if(e.error)return-1;let t=e.images;if(!e.inViewport)return t[0]?.loaded?0:-1;if(this.zoom>.9)return t[2]?.loaded?2:t[1]?.loaded?1:t[0]?.loaded?0:-1;let n=window.devicePixelRatio??1,r=Math.max(e.width,e.height)*this.zoom*n;return r<=fe[0]?t[0]?.loaded?0:-1:r<=fe[1]?t[1]?.loaded?1:t[0]?.loaded?0:-1:t[2]?.loaded?2:t[1]?.loaded?1:t[0]?.loaded?0:-1}computeNextImage(e,t){let n=this.computeShow(t);if(t.show===n)return;let r=n<=0||n<t.show;t.show=n,r?this.renderImage(t):this.scheduleRenderMainImage(e)}renderImage(e){this.updateImageVisibility(e,0),this.updateImageVisibility(e,1),this.updateImageVisibility(e,2)}scheduleRenderMainImage(e){this.scheduledRenderings.add(e),this.scheduled||(this.scheduled=!0,me.add(()=>me.add(this.processRenderMainImage)))}};function je(s){let e=s.intersectionRect;return e.width>5||e.height>5}function pe(s,e,t){let n=new Image;return n.loading=t===0?"eager":"lazy",Object.assign(n.style,e),n.style.position="absolute",s.appendChild(n),n}function ge(s,e,t){s&&(Object.assign(s.style,e),s.style.position="absolute",s.isConnected||t.appendChild(s))}var D=ot();function ie(){return window?.devicePixelRatio||0}var V=new DOMMatrixReadOnly;var X,ne=class{constructor(){l(this,"computedStyleCache",new Map);l(this,"sizeCache",new Map);l(this,"boundingClientRectCache",new Map);l(this,"matrixCache",new Map);l(this,"transformMatrixAndOffsetCache",new Map);l(this,"untransformedRectCache",new Map);Ie(this,X,new Map)}getComputedStyle(e){let t=this.computedStyleCache.get(e);return t||(t=getComputedStyle(e),this.computedStyleCache.set(e,{display:t.display,width:t.width,height:t.height,transform:t.transform,opacity:t.opacity,filter:t.filter,overflow:t.overflow,transformStyle:t.transformStyle,transformOrigin:t.transformOrigin,zIndex:t.zIndex}),t)}getCreates3dTransformContext(e){let t=this.getComputedStyle(e);return!(t.transformStyle!=="preserve-3d"||t.opacity!=="1"||t.filter!=="none"||t.overflow!=="visible"&&t.overflow!=="none")}transformOriginPoint(e,t=e/2){if(e===0)return 0;let n=Math.round(t/e*100)/100;return K()?et(e)*n:e*n}getTransformOrigin(e){let t=se(this,X).get(e);if(t)return t;let n=this.getComputedStyle(e),{width:r,height:o}=this.getSize(e),i=n.transformOrigin;if(!i)return{x:this.transformOriginPoint(r,.5),y:this.transformOriginPoint(o,.5)};let a=at(i),u={x:this.transformOriginPoint(r,a?.x),y:this.transformOriginPoint(o,a?.y)};return se(this,X).set(e,u),u}getCachedSize(e){return e?this.sizeCache.get(e):void 0}getCachedAttributes(e){let t=this.computedStyleCache.get(e),n=t?.zIndex?parseInt(t.zIndex):void 0,r=this.getTransformOrigin(e),o=this.getMatrix(e);return{zIndex:n,originX:r.x,originY:r.y,matrix:o.toJSON()}}getSize(e){let t=this.sizeCache.get(e);if(t)return t;let n=this.getComputedStyle(e),r=()=>{let u=e instanceof HTMLElement?e.offsetWidth:e.clientWidth;return n.display.startsWith("inline")?u+1:u},o=()=>e instanceof HTMLElement?e.offsetHeight:e.clientHeight,i=n.width.endsWith("px")?parseFloat(n.width):r(),a=n.height.endsWith("px")?parseFloat(n.height):o();return t={width:i||0,height:a||0},this.sizeCache.set(e,t),t}getCSSTransform(e){return this.getComputedStyle(e).transform||"none"}hasTransforms(e){return F()?this.getCSSTransform(e)!=="none":!this.getMatrix(e).isIdentity}getMatrix(e){let t=this.matrixCache.get(e);if(t)return t;let n=this.getCSSTransform(e);return t=n==="none"?V:new DOMMatrix(n),this.matrixCache.set(e,t),t}getBoundingClientRect(e){let t=this.boundingClientRectCache.get(e);return t||(t=e.getBoundingClientRect(),this.boundingClientRectCache.set(e,t),t)}getUntransformedRectInGroundNode(e,t,n=!0){let r=this.untransformedRectCache.get(e);if(r)return r;let o=this.getTransformAncestors(e),i={x:0,y:0,paintX:0,paintY:0,translationX:0,translationY:0},a=V,u={x:0,y:0,width:0,height:0};return[...o,e].forEach(c=>{let h=this.getSize(c),m=this.getBoundingClientRect(c),f=this.getMatrix(c),y=n?f.m41/f.m44:0,M=n?f.m42/f.m44:0,{x:I,y:p}=this.getTransformOrigin(c),x=V.translate(I,p).multiplySelf(f).translateSelf(-I,-p),C=R.pointsAtOrigin(h),g=R.fromPoints(R.points(m).map(O=>t.transformPoint(O))),{x:Y,y:E,matrix:T}=ze(a,x,g,C),P=N($(Y+y),$(E+M)),U=N(S(P.x),S(P.y)),B=this.hasTransforms(c),H=A.hasNonTranslationTransform(f),b=st(c),{rect:z,paintDelta:L,translation:q}=it(i,P,h,f,B,b),W=Ze(B,H,b,P,U);i.x+=W.x,i.y+=W.y,i.paintX+=L.x,i.paintY+=L.y,i.translationX+=q.x,i.translationY+=q.y,a=this.getCreates3dTransformContext(c)?T:A.flatProjectionMatrix(T),this.transformMatrixAndOffsetCache.set(c,{matrix:a,offset:{...i}}),this.untransformedRectCache.set(c,z),u=z}),u}getTransformAncestors(e){let t=[],n=e.parentElement;for(;!Te(n)&&!Be(n)&&n!==e.ownerDocument?.documentElement;)this.hasTransforms(n)&&t.unshift(n),n=n.parentElement;return t}getOffsetParentBoundingRect(e){if(!(e instanceof HTMLElement&&e.dataset.framerOffsetParentId))return;let t=document.getElementById(e.dataset.framerOffsetParentId);if(t)return this.getBoundingClientRect(t)}getOffsetParent(e){let t=e instanceof HTMLElement?e.offsetParent??e.parentElement:e.parentElement;return t instanceof HTMLElement&&t.dataset.layoutTemplateRoot?this.getOffsetParent(t):t}getParentRelativeRect(e,t,n,r){let o=this.getUntransformedRectInGroundNode(e,t,r),i=o,a,u,d=this.getOffsetParentBoundingRect(e);if(d){let m=t.transformPoint(new DOMPoint(d.x,d.y));return{x:o.x-m.x,y:o.y-m.y,width:o.width,height:o.height}}let c=this.getOffsetParent(e);return c&&!Be(c)?(i=this.getUntransformedRectInGroundNode(c,t),a=o.x-i.x,u=o.y-i.y):n?(a=n.x,u=n.y):(a=0,u=0),{x:a,y:u,width:o.width,height:o.height}}};X=new WeakMap;function Be(s){return s.classList.contains(he)||s.parentElement?.classList.contains(he)}function Ze(s,e,t,n,r){return F()&&s?r:(Z()||G())&&e?{x:t.includes(0)?n.x:r.x,y:t.includes(1)?n.y:r.y}:n}function Ke(s){let e=ie();if(e<2)return Math.round($(s));let t=He(s)/D;return te(t*e,0)/e}function Qe(s){return ie()<2?Math.round($(s)):Math.round($(s)*2)/2}function _e(s){let e=He(s),t=0,n=e%D,r=Math.trunc(e/D)*D;return ie()<=1?(n>=32&&(t=64),n<-32&&(t=-64)):(n>=16&&n<48&&(t=32),n>=48&&(t=64),n<-16&&n>=-24&&(t=-24),n<-24&&n>=-48&&(t=-32),n<-48&&n>=-56&&(t=-56),n<-56&&(t=-64)),(r+t)/D}function Je(){return Z()||G()?Qe:K()?_e:Ke}var S=Je();function re({x:s,y:e,width:t,height:n}){let r=S(s),o=S(e);return{x:r,y:o,width:S(s+t)-r,height:S(e+n)-o}}function et(s){let e=ie();return te(s*e,0)/e}function $(s){return te(s*D,0)/D}function He(s){return Math.trunc(s*D)}function tt({x:s,y:e,width:t,height:n},r){let{rotation:o,translation:i}=ye(r),a=N(s-i.x,e-i.y),u=re({...a,width:t,height:n}),d=N(u.x+S(t)/2,u.y+S(n)/2),c=V.translate(d.x+i.x,d.y+i.y).rotateSelf(o).translateSelf(-d.x,-d.y),h=A.convertPoint(c,R.center(u)),m=h.x-u.width/2,f=h.y-u.height/2;return{paintedRect:{x:m,y:f,width:u.width,height:u.height},snappedLayoutRect:u,translation:i}}function nt({x:s,y:e,width:t,height:n},r,o=[]){let{rotation:i,translation:a}=ye(r);o.includes(0)&&(a.x=-.5*t),o.includes(1)&&(a.y=-.5*n);let u=N(s-a.x,e-a.y),d=re({...u,width:t,height:n}),c=Math.round(t),h=Math.round(n),m=i!==0?c:d.width,f=i!==0?h:d.height,y=N(d.x+t/2,d.y+n/2),M=V.translate(y.x+a.x,y.y+a.y).rotateSelf(i).translateSelf(-y.x,-y.y),I=N(d.x+m/2,d.y+f/2),p=A.convertPoint(M,I),x=p.x-m/2,C=p.y-f/2;return{paintedRect:{x,y:C,width:m,height:f},snappedLayoutRect:d,translation:a}}function rt(s,e,{width:t,height:n},r){let{rotation:o,translation:i}=ye(r),a=N(e.x-i.x,e.y-i.y),u=s.x+S(a.x),d=s.y+S(a.y),c=N(u+t/2,d+n/2),h=V.translate(c.x+i.x,c.y+i.y).rotateSelf(o).translateSelf(-c.x,-c.y),m=A.convertPoint(h,N(u+t/2,d+n/2)),f=m.x-t/2,y=m.y-n/2;return{x:f,y,width:t,height:n}}function it(s,e,t,n,r,o){let i={x:0,y:0},a={x:-s.paintX,y:-s.paintY},u={x:s.translationX,y:s.translationY},d={x:s.x-u.x+e.x,y:s.y-u.y+e.y,...t};if(K()){let y=re(d),M=R.offset(y,{x:u.x+a.x,y:u.y+a.y});if(r){let{paintedRect:I,snappedLayoutRect:p,translation:x}=tt(d,n),C=R.offset(I,{x:u.x+a.x,y:u.y+a.y}),g=R.offset(p,x);return i={x:g.x-I.x,y:g.y-I.y},{rect:C,paintDelta:i,translation:x}}return{rect:M,paintDelta:i,translation:{x:0,y:0}}}if(Z()||G()){let y=re(d),M=R.offset(y,{x:u.x+a.x,y:u.y+a.y});if(r){let{paintedRect:I,snappedLayoutRect:p,translation:x}=nt(d,n,o),C=R.offset(I,{x:u.x+a.x,y:u.y+a.y}),g=R.offset(p,x);return i={x:g.x-I.x,y:g.y-I.y},{rect:C,paintDelta:i,translation:x}}return{rect:M,paintDelta:i,translation:{x:0,y:0}}}let c=s.x+e.x,h=s.y+e.y,m={x:c,y:h,...t};if(r){let y=R.offset({x:s.x+S(e.x),y:s.y+S(e.y),width:m.width,height:m.height},a),M=R.offset(rt(s,e,t,n),a);return i={x:y.x-M.x,y:y.y-M.y},{rect:M,paintDelta:i,translation:{x:0,y:0}}}return{rect:R.offset(m,a),paintDelta:i,translation:{x:0,y:0}}}function ye(s){let e=Math.atan2(s.b,s.a)*(180/Math.PI),t={x:s.e,y:s.f};return{rotation:e,translation:t}}function st(s){let e=[];return s instanceof HTMLElement&&(s.dataset.framerLayoutHintCenterX&&e.push(0),s.dataset.framerLayoutHintCenterY&&e.push(1)),e}function ot(){return F()?60:G()?100:64}function at(s){let[e,t]=s.split(" ").map(n=>parseFloat(n));if(!(!de(e)||!de(t)))return{x:e,y:t}}var v=Q("LayoutMeasureQueue"),dt=new DOMMatrixReadOnly,We=F()?1:0,Ge=class{constructor({shouldMeasureCallback:e,shouldMeasureCallbackDelayMs:t,renderingStateTracker:n}={}){l(this,"measureRequests",new Map);l(this,"measureRequestIds",new Set);l(this,"refinementRequests",new Map);l(this,"refinementRequestsByGroundNodeId",new Map);l(this,"richTextRenderIds",new Set);l(this,"previousScopeNodeId","");l(this,"previousZoomLevel");l(this,"previousGroundNodesInViewport");l(this,"resizeObserver",null);l(this,"shouldMeasureTimerStarted",!1);l(this,"shouldMeasureCallback");l(this,"shouldMeasureCallbackDelay");l(this,"renderingStateTracker");l(this,"runShouldMeasureCallback",()=>{this.shouldMeasureTimerStarted=!1,this.size()!==0&&this.shouldMeasureCallback&&this.shouldMeasureCallback()});l(this,"resized",(e,t)=>{if(this.resizeObserver===t)for(let n of e){let r=n.target;if(!r.isConnected||!r.id)return;let o=ue(r.id);this.add(o,r)}});this.shouldMeasureCallback=e,this.shouldMeasureCallbackDelay=t??100,this.renderingStateTracker=n}getRequestId(e,t){return t?`${e}-${t}`:e}add(e,t,n,r){if(v.trace("layout measure queue:",e),r&&w(ce(e),"Layout templates should only have a primary rendering"),!n&&this.measureRequests.has(t))return;let o=le(e);this.measureRequests.set(t,{nodeId:o,renderId:e,layoutTemplateSelector:r,children:n});let i=this.getRequestId(e,r);this.measureRequestIds.add(i),this.shouldMeasureCallback&&!this.shouldMeasureTimerStarted&&(setTimeout(this.runShouldMeasureCallback,this.shouldMeasureCallbackDelay),this.shouldMeasureTimerStarted=!0)}stylePresetChanged(e){for(let t of this.richTextRenderIds){let n=e.get(t);this.remeasureNodeAndAncestors(e,n)}this.richTextRenderIds.clear()}remeasureNode(e){this.remeasureCachedElements(e,(t,n)=>{v.trace("remeasureNode:",t,n)})}remeasureCachedElements(e,t){if(e.cache.elementByRenderId)for(let[n,r]of e.cache.elementByRenderId){let o=this.getRequestId(n,void 0);this.measureRequestIds.has(o)||(this.add(n,r,void 0,void 0),t?.(n,void 0))}if(e.cache.elementByLayoutTemplateSelector)for(let[n,r]of e.cache.elementByLayoutTemplateSelector){let o=this.getRequestId(e.id,n);this.measureRequestIds.has(o)||(this.add(e.id,r,void 0,n),t?.(e.id,n))}}remeasureNodeAndAncestors(e,t){t&&(this.remeasureCachedElements(t),this.remeasureNodeAndAncestors(e,e.getNodeParent(t)))}remeasureChildrenWithDOMRects(e){if(v.trace("remeasureChildrenWithLayout:",e.id),!!e.children&&!oe(e))for(let t of e.children)Pe(t)&&!t.usesDOMRectCached()||this.remeasureCachedElements(t,(n,r)=>{v.trace("remeasureChildrenWithLayout, child:",n,r)})}remeasureLayoutChildren(e){if(v.trace("remeasureLayoutChildren:",e.id),!!oe(e))for(let t of e.children)this.remeasureCachedElements(t,(n,r)=>{v.trace("remeasureLayoutChildren, child:",n,r)})}remeasureAutosizingAncestors(e,t){!t||!t.children||(v.trace("remeasureAutosizingAncestors:",t.id),this.remeasureLayoutChildren(t),ae(t)&&(t.widthType!==2&&t.heightType!==2||(this.remeasureCachedElements(t,(n,r)=>{v.trace("remeasureAutosizingAncestors, add:",n,r)}),this.remeasureAutosizingAncestors(e,e.getNodeParent(t)))))}process({scopeId:e,zoom:t,offsetX:n,offsetY:r,tree:o,groundNodesInViewport:i}){this.previousScopeNodeId!==e&&(v.debug("switching to a new page",this.previousScopeNodeId,e),this.richTextRenderIds.clear(),this.refinementRequests.clear(),this.refinementRequestsByGroundNodeId.clear(),$e(o.get(this.previousScopeNodeId)),this.previousScopeNodeId=e,this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeObserver=new ResizeObserver(this.resized));let a=!_(this.previousZoomLevel)&&t!==this.previousZoomLevel;this.previousZoomLevel=t;let u=!_(this.previousGroundNodesInViewport)&&i!==this.previousGroundNodesInViewport,d=new Set([...i]),c=new Set;if(!_(this.previousGroundNodesInViewport))for(let p of i)this.previousGroundNodesInViewport.has(p)&&(d.delete(p),c.add(p));if(this.previousGroundNodesInViewport=i,u&&this.processRefinementRequests(d),(u||a)&&t>We&&this.processRefinementRequests(c),v.trace("process:",this.size()),this.size()===0)return[];let h=dt.scale(t).translateSelf(-n,-r),m=[],f=new Map,y=new ne;for(let[p,x]of this.measureRequests){let C=o.getNode(x.nodeId);C&&(this.remeasureAutosizingAncestors(o,o.getNodeParent(C)),this.remeasureChildrenWithDOMRects(C),this.remeasureLayoutChildren(C))}let M=ut(this.measureRequests.values(),o,h),I=new Set;for(let[p,x]of this.measureRequests){let{nodeId:C,renderId:g,children:Y,layoutTemplateSelector:E}=x,T=o.getNode(C);if(!T)continue;if(!p.isConnected){v.trace("measureRequest: not connected",g);continue}E?(w(ce(g),"Layout templates should only have a primary rendering"),T.cache.elementByLayoutTemplateSelector??=new Map,T.cache.elementByLayoutTemplateSelector.set(E,p)):(T.cache.elementByRenderId??=new Map,T.cache.elementByRenderId.set(g,p));let P=M.get(C),U=P.matrix,B=P.rect;if(!i.has(P.id)){this.addRefinementRequest(g,{element:p,groundNodeId:P.id,measureRequest:x}),v.trace("measureRequest: refine",g);continue}let H;if(Y){H=[];for(let L of Y){if(Fe(L))continue;let q=ue(L.id),W=le(q),O=f.get(L);if(O||(O=y.getParentRelativeRect(L,U,B),f.set(L,O),q&&m.push({nodeId:W,renderId:q,layoutMetrics:O})),q){let j=o.getNode(W);if(j&&(R.equals(j.cache.getRawDOMRect(g),O)||I.add(q),j.cache.setRawDOMRect(g,O),!Le(j,T)))continue}H.push(O)}}let b=f.get(p);b?v.trace("measureRequest: cached",g,b):(b=y.getParentRelativeRect(p,U,B,!E),f.set(p,b),v.trace("measureRequest: getParentRelativeRect",g,b)),t<=We&&this.addRefinementRequest(g,{element:p,groundNodeId:P.id,measureRequest:x});let z={...b};E?Object.assign(z,y.getCachedAttributes(p)):z.childrenRects=H,T&&(be(T)?this.richTextRenderIds.add(T.id):we(T)&&this.resizeObserver?.observe(p),!E&&!R.equals(T.cache.getRawDOMRect(g)??null,b)&&(I.add(g),T.cache.setRawDOMRect(g,b))),m.push({nodeId:C,renderId:g,layoutTemplateSelector:E,layoutMetrics:z})}return this.measureRequests.clear(),this.measureRequestIds.clear(),I.size>0&&this.renderingStateTracker?.processNodesWithChangedRects(I),m}size(){return this.measureRequests.size}addRefinementRequest(e,t){let n=this.refinementRequests.get(e);if(n&&n.groundNodeId&&this.refinementRequestsByGroundNodeId.get(n.groundNodeId)?.delete(n),this.refinementRequests.set(e,t),t.groundNodeId){let r=this.refinementRequestsByGroundNodeId.get(t.groundNodeId);r||(r=new Set,this.refinementRequestsByGroundNodeId.set(t.groundNodeId,r)),r.add(t)}}processRefinementRequests(e){for(let t of e){let n=this.refinementRequestsByGroundNodeId.get(t);if(!(!n||n.size===0)){for(let r of n){if(this.refinementRequests.delete(r.measureRequest.renderId),!r.element.isConnected)continue;let o=this.getRequestId(r.measureRequest.renderId,r.measureRequest.layoutTemplateSelector);this.measureRequestIds.has(o)||(v.trace("refine:",r.measureRequest.renderId),this.measureRequests.set(r.element,r.measureRequest))}n.clear()}}}};function ut(s,e,t){let n=new Map,r=new Map;for(let{nodeId:o}of s){let i=t,a=e.get(o),u=[],d=a;for(;d&&e.getParent(d.id);){let c=r.get(d.id);if(c){d=e.get(c);break}d=e.getParent(d.id),d&&u.push(d.id)}if(d&&ae(d)){i=n.get(d.id)?.matrix||i.translate(d.left||0,d.top||0).inverse();for(let h of u)r.set(h,d.id)}else i=i.inverse();n.set(o,{id:d?.id,matrix:i,rect:d?Ee(d):null})}return n}function $e(s){if(!s)return;s.cache.elementByRenderId=void 0,s.cache.elementByLayoutTemplateSelector=void 0;let e=s.children;if(e)for(let t of e)$e(t)}function dn(s){return s.resultKeyPath.length>0&&ve(s)}function Xe(s,e){let t=e.value;if(Se(t)&&(w(!Me(t),"Computed values should not be possible in fetch fallback"),t=s.cache.getVariableReferenceValue(t)),e.type==="image"){if(!xe(t))return;let n=ke(t);return n?Re(n.identifier):void 0}return t}function un(s,e,t){let n=Xe(s,e.controlProp);try{return Ne(t,{fallbackValue:n,resultKeyPath:e.resultKeyPath,resultOutputType:e.controlProp.type})}catch{return e.errorControlProp?Xe(s,e.errorControlProp):n}}export{Ae as a,It as b,Ve as c,dn as d,Xe as e,un as f,Ge as g};
//# sourceMappingURL=chunk-72TIWYO6.mjs.map
