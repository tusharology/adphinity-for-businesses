import{a as U,b as H,d as M}from"chunk-VTBPB3CP.mjs";import{L as T,Q as y,R as C,S as L,U as w,V as b,W as k}from"chunk-V37HAKYT.mjs";import{a as p}from"chunk-XNPXGCKA.mjs";import{Kh as S}from"chunk-Y4KFFISW.mjs";import{f as D}from"chunk-KYQ6X7UF.mjs";import{e as l}from"chunk-75ILXMIH.mjs";import{a as I}from"chunk-R32HLP7P.mjs";import{_ as R}from"chunk-RT6MD2HE.mjs";import{W as v,da as h}from"chunk-EEV263O3.mjs";import{a}from"chunk-YOOGIIWU.mjs";import{a as g}from"chunk-HMF7T2NG.mjs";import{j as s}from"chunk-AHQIRSXG.mjs";var m=h("RemoteConnection"),P=1e3,u=class extends p.default{constructor(e){super();s(this,"isReconnect",!1);s(this,"messageQueue",[]);s(this,"baseURL");s(this,"socket");s(this,"stats");this.baseURL=M(e)}createPingInterval(e,n){return setInterval(()=>{if(a(this.socket===e,"Invalid socket"),a(this.stats===n,"Invalid stats"),performance.now()-n.lastSend()<P||n.pendingCount("ping")>0)return;let t="ping {}";e.send(t),n.sent("ping",t)},P)}connect(e){if(this.socket)return;let n=new URL(this.baseURL);n.searchParams.set("v",String(C)),n.searchParams.set("tunnel",I()??""),n.searchParams.set("treeSchema",String(l)),n.searchParams.set("treeVersion",String(e));let t=new WebSocket(n),o=new y;this.socket=t,this.stats=o,m.debug("Connecting:",t.url);let r;t.addEventListener("open",()=>{a(this.socket===t,"Invalid socket"),a(this.stats===o,"Invalid stats"),m.debug("Connected:",t.url),r=this.createPingInterval(t,o),this.emit("connect",this.isReconnect),this.isReconnect=!0,this.flushMessageQueue(t,o)}),t.addEventListener("message",i=>{a(this.socket===t,"Invalid socket"),a(this.stats===o,"Invalid stats");let c=i.data,d=b(c);if(o.received(c),d.type==="ack")return o.acked();d.type==="redirect"&&(this.baseURL=d.value.url),m.trace("Received:",d),this.emit("message",d)}),t.addEventListener("close",i=>{a(this.socket===t,"Invalid socket"),a(this.stats===o,"Invalid stats"),clearInterval(r);let c=w(i);m.debug("Disconnected:",c),this.socket=void 0,this.stats=void 0,this.emit("disconnect",c)})}disconnect(){this.socket?.close()}flushMessageQueue(e,n){if(e.readyState===WebSocket.OPEN){for(let{type:t,value:o}of this.messageQueue)try{let r=JSON.stringify(o),i=`${t} ${r}`;e.send(i),n.sent(t,i)}catch(r){m.warn("Error sending:",t,r)}this.messageQueue.length=0}}send(e){this.messageQueue.push(e),this.socket&&this.stats&&this.flushMessageQueue(this.socket,this.stats)}sendMessage(e){this.send(e)}onMessage(e){return this.on("message",e),()=>{this.off("message",e)}}};var E=h("remote:project"),O=100,A=class extends p.default{constructor(e,n,t,o,r){super();this.treeStore=e;this.componentLoader=n;this.userId=t;this.projectId=o;this.abortSignal=r;s(this,"connection");s(this,"treeDataHandler");s(this,"api");s(this,"modulesAPI");s(this,"assetService");s(this,"reconnectTimeout");s(this,"documentLoader");s(this,"shouldReconnect",!0);s(this,"shouldReloadOnDisconnect",!1);s(this,"postponedLastUpdate");s(this,"handleError",e=>{E.warn("Permanent error:",e),this.emit("disconnect","ClientSidePermanentError")});s(this,"handleRecoverableError",()=>{this.emit("disconnect","ClientSidePermanentError")});s(this,"handleUpdateProcessed",e=>{this.emit("update",e)});this.connection=new u(this.projectId),this.api=new H(this.connection,this.projectId),this.assetService=new R(this.api),this.modulesAPI=new U(this.api,this.connection),this.connection.on("disconnect",this.onDisconnect,this),this.connection.on("message",this.onMessage,this),this.assetService.refresh().catch(v),r?.addEventListener("abort",()=>this.disconnect(),{once:!0})}createDataHandler(){let e={error:this.handleError,errorRecoverable:this.handleRecoverableError,updateProcessed:this.handleUpdateProcessed};return S()?new T(this.treeStore.timeline,this.componentLoader,this.userId,this.projectId,e):new k(this.treeStore.timeline,this.componentLoader,this.projectId,e)}connect(){let e=this.treeDataHandler?.treeVersion??0;this.connection.connect(e),this.treeStore.timeline.setOnline(!0),this.shouldReconnect=!0}disconnect(){this.shouldReconnect=!1,this.cancelReconnect(),this.connection.disconnect(),this.treeStore.timeline.setOnline(!1)}maybeSend(){this.postponedLastUpdate&&(clearTimeout(this.postponedLastUpdate),this.postponedLastUpdate=void 0);let e=this.treeDataHandler?.maybeSend(this.connection)??"postpone";e==="postpone"&&(this.postponedLastUpdate=setTimeout(()=>this.maybeSend(),O)),e==="didSend"&&D("editor_bar_interaction",{page:"editor-bar-project-page",id:"editor-bar-tree-update"})}cancelReconnect(){clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0}scheduleReconnect(e){this.cancelReconnect(),this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this.connect()},e)}onDisconnect(e){if(this.treeDataHandler=void 0,this.shouldReloadOnDisconnect){window.location.reload();return}if(this.shouldReconnect||E.warn("Disconnect:",e),this.shouldReconnect&&L(e)){let n=N(e);this.scheduleReconnect(n)}}onMessage(e){switch(e.type){case"treeMessage":return this.handleTreeMessage(e.value);case"treeUpdate":return this.handleTreeUpdate(e.value);case"rows":return this.handleRows(e.id,e.value);case"confirmRows":return this.handleConfirmRows(e.value);case"notifyProjectChange":switch(e.value.waitForRestart&&(this.shouldReloadOnDisconnect=!0),e.value.scope){case"assets":return this.assetService.refresh();case"assetsInvalidated":return this.assetService.refreshFully();default:return}}}handleTreeMessage(e){if(e.type!=="init")return;let n=g(),t=new URL(e.data.file,n.app);this.treeDataHandler||(this.treeDataHandler=this.createDataHandler()),this.treeDataHandler.handleInit(e.data.treeVersion,e.data.initialUpdates).needsDownload&&this.downloadDocument(t.href,e.data.treeVersion)}handleTreeUpdate(e){a(this.treeDataHandler,"Cannot handle remote updates before init"),this.treeDataHandler.handleTreeUpdate(e),this.treeDataHandler.processRemoteUpdates()}handleRows(e,n){a(this.treeDataHandler,"Cannot handle remote updates before init"),this.treeDataHandler.handleRows(e,n),this.treeDataHandler.processRemoteUpdates()}handleConfirmRows(e){a(this.treeDataHandler,"Cannot handle remote updates before init"),this.treeDataHandler.handleConfirmRows(e),this.treeDataHandler.processRemoteUpdates()}downloadDocument(e,n){let t=this.treeDataHandler;a(t?.waitingForTree,"Must be waiting for tree"),this.documentLoader&&(this.documentLoader.scheduler.cancel(),this.documentLoader.removeAllListeners());let o={partialParsing:!0,loadInBackground:!0,async refreshAccessToken(i){return{...i,credentials:"include"}}},r=t.createLoader(e,n,o);this.documentLoader=r,r.on("loadedFirstData",i=>{i.setService("metadata",{projectId:this.projectId}),r.pauseLoadingScopes();let c={isLoading:!0};t.setTree(i,n,c),t.processRemoteUpdates(),r.canvasTreeVersion<l&&this.emit("disconnect","ClientTooNew"),r.canvasTreeVersion>l&&this.emit("disconnect","ClientNeedsUpdate")}),r.on("loadedAllData",()=>{t.loadedAllScopes(),this.emit("update",this.treeStore.timeline.tree)}),r.on("loadedScope",i=>{t.loadOneScope(i,!1),this.emit("update",this.treeStore.timeline.tree)}),r.start().catch(v)}};function N(f){return f==="ReconnectToNewServer"?25:1e3}export{A as a};
//# sourceMappingURL=chunk-VN7YVIME.mjs.map
