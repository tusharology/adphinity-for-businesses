import{a as L}from"chunk-WBCNPH7M.mjs";import{e as q,f as $}from"chunk-TMW6MU5R.mjs";import{a as k}from"chunk-3HZQE2SB.mjs";import{b as j}from"chunk-DW74T73Q.mjs";import{h as M}from"chunk-CHLWPW46.mjs";import{b as S,c as C}from"chunk-LDL4GN3P.mjs";import{j as o}from"chunk-5QQ5KTFK.mjs";import{a as P}from"chunk-7GSEC7H4.mjs";import{p as w}from"chunk-OBUCKN56.mjs";import{j as A}from"chunk-CMAEAGWD.mjs";import{a as x}from"chunk-JB2N3EQZ.mjs";import{k as R}from"chunk-6E4TUQ3S.mjs";import{da as b,u as I}from"chunk-EEV263O3.mjs";import{a as g,b as v}from"chunk-YOOGIIWU.mjs";import{a as m}from"chunk-HMF7T2NG.mjs";import{e as D,j as l}from"chunk-AHQIRSXG.mjs";var U=class{constructor(e,s){this.api=e;this.socket=s;l(this,"emitter",new R);s.onMessage(async t=>{if(t.type!=="moduleEvents")return;let a=await Promise.all(t.value.events.map(async r=>{switch(r.type){case"delete":return r;case"save":return{type:"save",module:await e.getModule({moduleId:r.id})};default:v(r)}}));this.emitter.emit({events:a})})}notify(e){this.socket.send({type:"moduleEvents",value:{events:e}})}async create(e){let s=await this.api.createModule(e);return this.notify([{type:"save",id:s.id,saveId:s.saveId}]),s}async delete(e){let s=await this.api.deleteModule(e);return this.notify([{type:"delete",id:s.id}]),s}async getModuleDependencies(e){return this.api.getModuleDependencies(e)}async list(e){return this.api.listModules(e)}async kits(){return this.api.listKits()}async listNamespaces(){return this.api.listNamespaces()}async listPublishedModules(e){return this.api.listPublishedModules(e)}async lookUpModules(e){return this.api.lookUpModules(e)}async publish(e){return this.api.publishModule(e)}async save(e){let s=await this.api.saveModule(e);return this.notify([{type:"save",id:s.id,saveId:s.saveId}]),s}async saveBatch(e){let s=await this.api.saveModules(e);return this.notify(s.data.map(t=>({type:"save",id:t.id,saveId:t.saveId}))),s}async update(e){let s=await this.api.updateModule(e);return this.notify([{type:"save",id:s.id,saveId:s.saveId}]),s}moduleEventsStream(e){return this.emitter.newStream(e)}async createNamespace(e){return this.api.createNamespace(e)}async enqueueKitScreenshots(e){return this.api.enqueueKitScreenshots(e)}};var u=D(x(),1);async function E(n,e,s,t){let a=`upload${Math.random()}`;try{t({type:"add",key:a,variant:"progress",icon:s,primaryText:"Uploading remote file\u2026",duration:1/0,showCloseButton:"never"});let r=await o.post(n,{url:e});return t({type:"add",key:a,variant:"success",primaryText:"Your file",secondaryText:"has been uploaded.",duration:1e4,icon:"success",moveToTop:!0}),r}catch(r){throw t({type:"add",key:a,variant:"error",primaryText:"Error uploading file.",secondaryText:"Please try again.",duration:3e4,icon:"error",moveToTop:!0}),r}}var d=b("useAPI"),B=I()&&navigator.userAgent.includes("Version/16"),y=window.CompressionStream&&!B,h=class{constructor(e,s,t=P){this.socket=e;this.projectId=s;this.dispatch=t;l(this,"apiBaseURL",m().api);l(this,"packagesPerPage",36)}wait(e){o.wait(e)}normalizeRole(e){return e==="contentCollaborator"&&!w.isOn("contentEditor")?"collaborator":e}getACL(){o.get(`/web/projects/${this.projectId}/acl/`).then(({users:e,invites:s,accessRequests:t})=>{let a=e.map(i=>({...i,kind:"user",role:this.normalizeRole(i.role),permissions:i.permissions})),r=s.map(i=>({...i,kind:"invite",role:this.normalizeRole(i.role),permissions:i.permissions}));this.dispatch({type:"resetACL",acl:[...a,...r],accessRequests:t.map(i=>({...i,kind:"accessRequest"}))})}).catch(e=>d.error("Failed to get ACL:",e))}setInitialProject(e){e.then(s=>{this.dispatch({type:"setProject",project:s})}).catch(s=>d.error("Failed to set initial project:",s))}getProject(){o.get(`/web/projects/${this.projectId}`,{includeUsageDataV2:"true"}).then(e=>{this.dispatch({type:"setProject",project:e})}).catch(e=>d.error("Failed to get project:",e))}async pollProject({intervalMillis:e,attempts:s,stopCondition:t}){let a=await k(this.projectId,{intervalMillis:e,attempts:s,stopCondition:t});return a.status===0&&(this.dispatch({type:"setProject",project:a.project}),this.notifyProjectChange("metadata")),a}async invite(e){let s=await q(this.projectId,e);return s.status===0&&(this.dispatch({type:"updateACL",acl:[s.aclEntry]}),this.notifyProjectChange("acl")),s}async removeInvite({id:e}){await o.deleteRaw(`/web/projects/${this.projectId}/invites/${e}`),this.notifyProjectChange("acl"),this.getACL()}async updateUserPermissions(e){let s=await $(this.projectId,e);return s.status===0&&(this.notifyProjectChange("acl"),this.getACL()),s}async requestAccess(e){let s=await L(e);return this.notifyProjectChange("acl"),s}async grantProjectAccessRequest({id:e}){let s=await S(e);return s.status===0&&(this.notifyProjectChange("acl"),this.getACL()),s}async denyProjectAccessRequest({id:e}){let s=await C(e);return s.status===0&&(this.notifyProjectChange("acl"),this.getACL()),s}async forceRefreshACL(){this.notifyProjectChange("acl"),this.getACL()}async removeUserPermissions({id:e}){await o.deleteRaw(`/web/projects/${this.projectId}/acl/${e}`),this.notifyProjectChange("acl"),this.getACL()}async updateProject(e,s=!0){s&&this.dispatch({type:"updateProject",changes:e});try{await j(this.projectId,e),this.getProject(),this.notifyProjectChange("metadata")}catch(t){throw d.error("Failed to update project:",t),t}}async subscribeToNotifications(){await o.postRaw(`/web/projects/${this.projectId}/threads/notifications/subscribe`)}async unsubscribeFromNotifications(){await o.postRaw(`/web/projects/${this.projectId}/threads/notifications/unsubscribe`)}async getAssets(e={}){let{updatedFrom:s}=e,t=`/web/v2/projects/${this.projectId}/assets/`;if(s){let r=new URLSearchParams({updatedFrom:s});t+=`?${r.toString()}`}let a=await o.get(t);if(!Array.isArray(a.assets)){let r=new Error("malformed /projects/./assets/ response");throw d.reportError(r,a),r}return a}async uploadAsset(e,{maxFileSize:s,onExceedsCustomMaxSize:t,onToast:a=P}={}){let r=new URL(`/web/projects/${this.projectId}/assets`,this.apiBaseURL).href,i=await M({endpoint:r,fieldName:"file",file:e,icon:"image",onToast:a,customMaxSize:s,onExceedsCustomMaxSize:t});return i&&this.notifyProjectChange("assets"),i}async uploadAssetByURL(e,s=P){let t=await E(`/web/projects/${this.projectId}/assets/fetch`,e,"image",s);return t&&this.notifyProjectChange("assets"),t}async duplicateAssets(e,s){if(this.projectId===s)return d.warn("Attempted to duplicate assets for current project"),[];let t=await o.post(`/web/projects/${this.projectId}/assets/duplicate`,{sourceProjectId:s,keys:e});return t&&this.notifyProjectChange("assets"),t.assets}async duplicateWorkspaceAssets(e,s){let t=await o.post(`/web/projects/${this.projectId}/assets/duplicate`,{sourceTeamId:s,keys:e});return t&&this.notifyProjectChange("assets"),t.assets}async duplicateModuleAssets(e,s,t){let a={moduleId:e,saveId:s};t&&t.length>0&&(a.keys=t);let r=await o.post(`/web/projects/${this.projectId}/assets/duplicate-module`,a);return r&&this.notifyProjectChange("assets"),r.assets}async deleteAssets(e){let s=await o.delete(`/web/projects/${this.projectId}/assets/batch`,{keys:e});return this.notifyProjectChange("assetsInvalidated"),s}async createModule(e){let s=new FormData;return this.addModuleRequestToForm(e,s),await o.postRaw("/modules/v1/modules/",s).then(a=>a.json())}async deleteModule({moduleId:e}){return await o.deleteRaw(`/modules/v1/modules/${e}`).then(t=>t.json())}async getModule({moduleId:e,saveId:s}){let t;return s?t=`/modules/v1/modules/${e}/saves/${s}`:t=`/modules/v1/modules/${e}`,o.get(t)}async getModuleDependencies({moduleId:e,saveId:s}){return o.get(`/modules/v1/modules/${e}/saves/${s}/dependencies/`)}async listModules({types:e}={}){let s=new URLSearchParams;if(e)for(let a of e)s.append("type",a);return await o.get(`/modules/v1/modules/?${s.toString()}`,{projectId:this.projectId})}async listKits(){return await o.get("/modules/v1/kits/",{projectId:this.projectId})}async listNamespaces(){return await o.get("/modules/v1/namespaces/")}async createNamespace(e){return await o.post("/modules/v1/namespaces/",e)}async listPublishedModules({namespace:e}){let s=`/modules/v1/modules/namespaces/${encodeURIComponent(e)}/published/`;return await o.get(s)}async lookUpModules(e){return o.post("/modules/v1/modules/batch/lookup/",e)}async publishModule({namespace:e,name:s,...t}){let a=`/modules/v1/namespaces/${encodeURIComponent(e)}/published/${encodeURIComponent(s)}`;return await o.post(a,t)}async updateModule({moduleId:e,...s}){return await o.post(`/modules/v1/modules/${e}`,s)}async saveModule(e){let s=new FormData;return await this.addModuleRequestToForm(e,s),await o.postRaw(`/modules/v1/modules/${e.moduleId}/saves/`,s).then(a=>a.json())}async saveModules({batch:e}){let s=new FormData;return await Promise.all(e.map(a=>this.addModuleRequestToForm(a,s))),await o.postRaw("/modules/v1/modules/batch/saves/",s).then(a=>a.json())}async addModuleRequestToForm(e,s){let{files:t,...a}=e,r=s.getAll("metadata").length;y&&window.CompressionStream&&(a.transferEncoding="gzip"),s.append("metadata",JSON.stringify({...a,projectId:this.projectId,files:t.map(({content:i,bytes:c,...p})=>p)})),await Promise.all(t.map(async i=>{let c=i.content??i.bytes;g(!A(c),"File needs content or bytes");let p=new Blob([c]);if(y&&window.CompressionStream){let F=new window.CompressionStream("gzip"),N=p.stream();p=await new Response(N.pipeThrough(F)).blob();let f=c.length-p.size,T=f/c.length*100;d.debug("Saved",f,"bytes",`(${T.toFixed(1)}%)`,"compressing",i.name)}s.append(`files[${r}]`,new File([p],i.name))}))}async enqueueKitScreenshots(e){let s=new FormData,t;if(y&&window.CompressionStream){let a=new window.CompressionStream("gzip"),r=new Response(e.kitPageContent).body;g(r,"Section page content body is not readable");let i=await new Response(r.pipeThrough(a)).blob();t=new File([i],"kitPage.html.gz",{type:"application/gzip"})}else t=new File([e.kitPageContent],"kitPage.html",{type:"text/html; charset=utf-8"});s.append("sectionPage",t),s.append("sectionIds",JSON.stringify(e.ids)),await o.postRaw(`/modules/v1/modules/${e.moduleId}/saves/${e.saveId??"draft"}/kit-screenshots/`,s)}async getFileList(){return o.getRaw(`/web/vekter/projects/${this.projectId}/files`)}async getFile(e){return o.getRaw(`/web/vekter/projects/${this.projectId}/files/${e}`)}async saveFile(e,s){let t=new FormData,a=new File([s],e,{type:"text/plain"});return t.set("file",a),o.postRaw(`/web/vekter/projects/${this.projectId}/files/${e}`,t,void 0)}async deleteFile(e){return o.deleteRaw(`/web/vekter/projects/${this.projectId}/files/${e}`)}async getBuildOutput(e){return o.getRaw(`/web/projects/${this.projectId}/files/${e}`)}async getPackage(e){let{fromPublicPackages:s,packageName:t}=e;return o.get(`/store/packages${s?"":"/private"}/${t}`)}async deletePackage(e){let{fromPublicPackages:s,packageName:t}=e;await o.deleteRaw(`/store/packages${s?"":"/private"}/${t}`)}async getPackageVersionStatus(e){let{isPrivate:s,packageName:t,version:a}=e;return o.get(`/store/packages${s?"/private":""}/${t}/version/${a}`)}async preflightPackage(e){let{fromPublicPackages:s,body:t}=e;return o.post(`/store/packages${s?"":"/private"}/preflight`,t)}async findPackage(e){let{fromPublicPackages:s,friendlyName:t,spaceId:a}=e;return o.getRaw(`/store/packages${s?"":"/private"}/find-by-slugify`,{name:t,spaceId:a})}async findPackages(e){let{fromPublicPackages:s,query:t,offset:a,spaceIds:r}=e;return o.getRaw(`/store/packages${s?"":"/private"}/search`,{query:t,offset:a,limit:this.packagesPerPage,spaceIds:r})}async favoritePackage(e){let{fromPublicPackages:s,packageName:t}=e;return o.postRaw(`/store/packages${s?"":"/private"}/${t}/favorite`)}async unfavoritePackage(e){let{fromPublicPackages:s,packageName:t}=e;return o.deleteRaw(`/store/packages${s?"":"/private"}/${t}/favorite`)}async getPackages(e){let{fromPublicPackages:s,section:t,offset:a,spaceIds:r}=e;return o.getRaw(`/store/packages${s?"":"/private"}/${t||""}`,{offset:a,limit:this.packagesPerPage,spaceIds:r})}async getPopularPackages(e){let{fromPublicPackages:s,offset:t,days:a,spaceIds:r}=e;return o.getRaw(`/store/packages${s?"":"/private"}/popular`,{offset:t,days:a,limit:this.packagesPerPage,spaceIds:r})}async getFeaturedPackages(e){let{fromPublicPackages:s,offset:t}=e;return o.getRaw(`/store/packages${s?"":"/private"}/`,{featured:!0,offset:t,limit:this.packagesPerPage})}async getPublisherPackages(e){let{publisherId:s,offset:t}=e;return o.getRaw(`/store/packages/published-by/${s}`,{offset:t,limit:this.packagesPerPage})}async getTrendingPackages(){return o.getRaw("/store/packages/trending")}async getPackagesMetadata(e){return o.post("/store/meta/get-many",e)}async listPhotos(e){return o.get("/web/unsplash/photos",e)}async searchPhotos(e){return o.get("/web/unsplash/search/photos",e)}async getRandomPhoto(e){return o.get("/web/unsplash/photos/random",e)}async downloadPhoto(e){return o.get(`/web/unsplash/photos/${e.id}/download`)}async checkControlRequest(){return o.get("/auth/analysis/account-sharing")}async takeControl(e){return o.post("/auth/analysis/account-sharing/take-control",e)}notifyProjectChange(e){this.socket.send({type:"notifyProjectChange",value:{scope:e}})}};function Pe(n,e,s){let t=(0,u.useMemo)(()=>new h(n,e.projectId,s),[n,e.projectId,s]);(0,u.useEffect)(()=>{t.getACL()},[t]);let a=(0,u.useRef)(e);return a.current=e,(0,u.useEffect)(()=>n.onMessage(r=>{let i=a.current;if(r.type==="join"){if(i.aclById[r.id])return}else if(r.type==="welcome"){if(i.acl.length===0)return;let c=!1;for(let p of i.activeIds)if(!i.aclById[p]){c=!0;break}if(!c)return}else return;t.getACL()}),[t,n]),t}function fe(n){let e=m(),s=new URL(e.app);return s.protocol=s.protocol==="http:"?"ws:":"wss:",s.pathname=`/projects/${n}/socket`,s.href}export{U as a,h as b,Pe as c,fe as d};
//# sourceMappingURL=chunk-FTBG2PD5.mjs.map
