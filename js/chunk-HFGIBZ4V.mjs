import{c as M,d as k}from"chunk-R32HLP7P.mjs";import{a as A,b as F}from"chunk-JB2N3EQZ.mjs";import{c as b,e as S,g as x}from"chunk-6E4TUQ3S.mjs";import{W as g,X as T,da as P,f as I}from"chunk-EEV263O3.mjs";import{b as C}from"chunk-YOOGIIWU.mjs";import{e as y}from"chunk-AHQIRSXG.mjs";var h=y(A());function G(r,i){let m={service:r.service.service,onDiscover:r.onDiscover},p=(0,h.useRef)(m);if(p.current.service!==m.service)throw new Error("useServiceStream: service must be identical between re-renders");let E={onStreamValue:i,onError:r.onError},l=(0,h.useRef)(E);l.current=E;let f=(0,h.useRef)(),v=()=>{let a=f.current;f.current=void 0,a?.cancel().catch(()=>{})},{channel:u}=r;(0,h.useEffect)(()=>u?((async()=>{let n=!1,w=0;for(;!n;){n=!0;try{let e=p.current,t=await S.shared().discover(e.service,u),d=e.onDiscover(t);f.current=d,w=0,await d.read(c=>l.current.onStreamValue(c))}catch(e){let t=l.current.onError(T(e));if(w++,w>1)continue;t?.retry===!0&&(await I(0),n=!1)}}})().catch(g),v):void 0,[u])}function Y(r){if(r instanceof b.ServiceGone)return{retry:!0};g(r)}var o=y(A());var H="autoplay; ambient-light-sensor; accelerometer; camera; display-capture; encrypted-media; fullscreen; geolocation; gyroscope; magnetometer; microphone; midi; picture-in-picture; usb; xr-spatial-tracking",U="autoplay",N="autoplay; ambient-light-sensor; accelerometer; camera; display-capture; encrypted-media; fullscreen; geolocation; gyroscope; magnetometer; microphone; midi; picture-in-picture; usb; xr-spatial-tracking; clipboard-read; clipboard-write";function _(r){let i;switch(r){case"on_page":i=U;break;case"editor":i=H;break;case"preview":i=N;break;default:C(r)}return i}var O=y(F()),V=P("services:hooks:useiframewithchannel"),R=class extends Error{constructor(m,p={}){super(m);this.extras=p}};function X(r){let{onSetup:i=()=>{},targetOrigin:m,type:p,src:E}=r,l=E;if(E){let{pathname:e,search:t,hash:d}=new URL(E),c=`${e}${t}${d}`;k(c),l=M(c).url}let[f,v]=(0,o.useReducer)((e,t)=>(e&&S.shared().unregister(e).catch(d=>{d instanceof b.ServiceGone||g(d)}),t),null),u=(0,o.useRef)(null),a=(0,o.useRef)(null),n=(0,o.useRef)({onError:null,onLoad:null});return(0,o.useEffect)(()=>{if(!l||!u.current){a.current=null,f&&v(null);return}if(a.current)return;let e=document.createElement("iframe");e.src=l,e.style.border="none",e.style.display="block",e.style.height="100%",e.style.width="100%",e.dataset.testid=`${p}-iframe`,e.allowFullscreen=!0;let t=s=>{v(null),V.reportError(new R("iframe load error",{message:s.message,filename:s.filename,lineno:s.lineno,colno:s.colno,error:s.error}))};e.addEventListener("error",t),n.current.onError=t;let d=new URL(l,document.baseURI).origin,c=e.sandbox;c?.add("allow-downloads"),c?.add("allow-popups"),c?.add("allow-popups-to-escape-sandbox"),c?.add("allow-same-origin"),c?.add("allow-scripts"),c?.add("allow-forms"),e.allow=_(p==="canvas"?"editor":"preview"),u.current.appendChild(e),a.current=e;let D=()=>{let{contentWindow:s}=e;return s?new x(s,m??d):(u.current?.removeChild(e),null)},L=()=>{let s=D();v(s)};return e.addEventListener("load",L),n.current.onLoad=L,i(e)},[f,v,i,l,m,p]),(0,o.useEffect)(()=>()=>{n.current.onError&&a.current?.removeEventListener("error",n.current.onError),n.current.onLoad&&a.current?.removeEventListener("load",n.current.onLoad),n.current.onError=null,n.current.onLoad=null,a.current=null,v(null)},[]),[(0,o.useCallback)(function(t){return(0,o.useEffect)(()=>{if(u.current?.children.length===0&&a.current)throw new Error("IFrameWithChannel was re-rendered. The Service connection will be broken.")}),(0,O.jsx)("div",{...t,ref:u})},[]),f,a.current]}export{_ as a,X as b,G as c,Y as d};
//# sourceMappingURL=chunk-HFGIBZ4V.mjs.map
